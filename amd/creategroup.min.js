// This file is part of Moodle - https://moodle.org/
//
// Moodle is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Moodle is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.

/**
 * Javascript
 *
 * @package     local_classroom_teams
 * @author      2022 JuanCarlo Castillo <juancarlo.castillo20@gmail.com>
 * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @copyright   2022 JuanCa Castillo & Eurecat.dev
  */

require(["core/first","jquery","jqueryui","core/ajax"],function(_core,$){$(document).ready(function(){var $nbsp="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;",$processing,$choose,$allstudents,$nostudent,$nofilter,$coursecompleted,$meangrade,$cFilter,$pFilter,$cCompleted,$mGrade,$notenoughuser,$thresholdempty,$thresholdzero,$thresholdnumber,$selecthomogenic,$typename,$idcourse,$idgroup,$formatosplit,$numberstudent,$numberstudentzero,$numbergrouop,$nostudent,$numbergrouopzero;function getlang(){$.ajax({url:"classes/lang/getlang.php",success:function(response){if(response=="ca"){getlangca()}else if(response=="es"){getlanges()}else{getlangen()}}})}getlang();function getlangca(){$processing="Processant, si us plau esperi...";$choose="Seleccioni...";$allstudents="Tots els estudiants";$nostudent="No hi ha estudiants";$nofilter="No hi ha cap filtre personalizat.";$coursecompleted=$nbsp+"Curs completat";$meangrade=$nbsp+"Nota media";$cFilter="Filtro del curso";$pFilter="Filtro personalizado";$cCompleted="Curso completado";$mGrade="Nota mitjana";$notenoughuser="No existeix suficients usuaris";$thresholdempty='* El camp "llindar" no pot estar buit';$thresholdzero='* El camp "llindar" no pot estar buit o ser zero';$thresholdnumber='* Insereixi un número en el camp "llindar"';$selecthomogenic="* Seleccioni un grup homogeni o heterogeni";$typename="* Aquest camp no pot estar buit";$idcourse="* Si us plau, seleccioni un curs";$idgroup="* Si us plau, seleccioni un grup per a aquest curs";$formatosplit="* Si us plau, seleccioni una manera de dividir aquest grup.";$numberstudent="* Si us plau introdueixi un nombre d'estudiants";$numberstudentzero="* El camp estudiants no pot ser zero";$numbergrouop="* Si us plau, insereixi un nombre de grups";$numbergrouopzero="* El camp grups no pot ser zero";Nostudents=" * No students found"}function getlanges(){$processing="Procesando, la primera vez puede tomar un momento, por favor espere...";$choose="Seleccione...";$allstudents="Todos los estudiantes";$nostudent="No hay estudiantes";$nofilter="No hay ningún filtro personalizado.";$coursecompleted=$nbsp+"Curso completado";$meangrade=$nbsp+"Nota media";$cFilter="Filtro del curso";$pFilter="Filtro personalizado";$cCompleted="Curso completado";$mGrade="Nota media";$notenoughuser="No existe suficientes usuarios";$thresholdempty='* El campo "umbral" no puede estar vacío';$thresholdzero='* El campo "umbral" no puede estar vacío o ser cero';$thresholdnumber='* Inserte un número en el campo "umbral"';$selecthomogenic="* Seleccione un grupo homogéneo o heterogéneo";$typename="* Este campo no puede estar vacío";$idcourse="* Por favor, seleccione un curso";$idgroup="* Por favor, seleccione un grupo para éste curso";$formatosplit="* Por favor, seleccione una manera de dividir éste grupo.";$numberstudent="* Por favor introduzca un número de estudiantes";$numberstudentzero="* El campo estudiantes no puede ser cero";$numbergrouop="* Por favor, inserte un número de grupos";$numbergrouopzero="* El campo grupos no puede ser cero.";Nostudents=" * No students found"}function getlangen(){$processing="Processing, the first time can take a moment, please hold...";$choose="Choose...";$allstudents="All students";$nostudent="No students here.";$nofilter="No personal filter.";$coursecompleted=$nbsp+"Course completed";$meangrade=$nbsp+"Mean grade";$cFilter="Course Filter";$pFilter="Personal Filter";$cCompleted="Course Completed";$mGrade="Mean grade";$notenoughuser="Not Enough Users.";$thresholdempty="* Threshold field cannot be left empty.";$thresholdzero="* Threshold field cannot be zero or empty.";$thresholdnumber="* Insert a number for the threshold.";$selecthomogenic="* Select Homogenic or Heterogenic group.";$typename="* This field cannot be empty.";$idcourse="* Please, select a course.";$idgroup="* Please, select a group for this course.";$formatosplit="* Please, select a format to split the new group.";$numberstudent="* Please insert the number of students.";$numberstudentzero="* Students field cannot be zero.";$numbergrouop="* Please insert the number of groups.";$numbergrouopzero="* Groups field cannot be zero.";Nostudents=" * No se han encontrado alumnos"}let filter="";let personalfilter=[];$("#save_button").hide();$("#managedelcontainer").hide();let idarray=[];let idarrayuser=[],history={};let historySt=[],tandemvalue="",personalfiltervalue="",personalfilterstudent="";let homogenic=0,threshold=0;let togglevalue,name,arraysplitgroups,groupcourse,tandem,extraida,customfilter,extraida2;let valueFilterId,valueFilterName,historySave;let valuenametitle;let foundstudent=false;function idgroup(){let idgroup=$("#menuformato").val();if(idgroup===null||!idgroup||idgroup==0||idgroup==undefined){idgroup=0}return idgroup}$("#typeNameFilter").keyup(function(){valuenametitle=$("#typeNameFilter").val()});function emptyvaluetitle(){document.getElementById("typeNameFilter").value=""}$("#menucurso").change(function(){restar();$("#blocAssignConte").html("");$("#save_button").hide();let idcourse=idCourse();$.ajax({data:{idcourse:idcourse},url:"classes/course/getcoursehavegroup.php",beforeSend:function(){$("#contenedor_ajax").html($processing)},success:function(response){if(response!="1"){$("#group_course").show();insertgroupcourseoption()}else{$("#group_course").hide();getstudentsnogroup()}}})});function idCourse(){let idCourse=$("#menucurso").val();return idCourse}function getstudentsnogroup(){let idcourse=idCourse();$.ajax({data:{idcourse:idcourse},url:"classes/course/getstudentsnogroup.php",success:function(response){$(".fitem").remove();const element=$.parseJSON(response);if(Object.keys(element).length===0){$("#contenedor_ajax").hide();$("#blocAssignConte").html($nostudent);foundstudent=true}else{$("#contenedor_ajax").show();$("#blocAssignConte").html("");insertintoblocassignconte(element);foundstudent=false}}})}function insertgroupcourseoption(){$.ajax({data:{value:idCourse()},url:"classes/course/getgroupcourse.php",beforeSend:function(){$("#contenedor_ajax").html($processing)},success:function(response){let data=JSON.parse(response);$("#menuformato").html("");$("<option/>").val(-2).html($choose).appendTo("#menuformato");$("<option/>").val(-1).html($allstudents).appendTo("#menuformato");$.each(data,(_index,value)=>{$("<option/>").val(value.id).html(value.name).appendTo("#menuformato")})}})}$("#menuformato").change(function(){if(gruposformato()==-1){getstudentsnogroup()}else if(gruposformato()==0||gruposformato()==1){getstudentswithgroup()}else{getstudentswithgroup()}});function gruposformato(){let gruposformato=$("#menuformato").val();return gruposformato}function getstudentswithgroup(){$.ajax({data:{value:idgroup()},url:"classes/course/getstudentwithgroup.php",success:function(response){$(".fitem").remove();const element=$.parseJSON(response);insertintoblocassignconte(element)}})}function insertintoblocassignconte(element){idarray=[];let idname={};idarrayuser=[];$.each(element,function(_item,value){if(value.id!=-1){idarray.push(value.id);name=value.name;idname[value.id]=name;idarrayuser.push(idname);$("#blocAssignConte").show();$("#blocAssignConte").append(`<p value= "`+value.id+`" class="fitem ">`+value.name+`</p>`);$("#contenedor_ajax").hide()}else if(value.id==0){$(".fitem").remove();$("#contenedor_ajax").show();$("#blocAssignConte").html($nostudent)}else{$(".fitem").remove();$("#contenedor_ajax").show();$("#blocAssignConte").html($nostudent)}});idarrayuser=idarrayuser.shift()}$("#menuformatoToSplit").change(function(){if(formatoToSplit()==0){$("#byGroup").show();$("#byStudent").hide()}else if(formatoToSplit()==1){$("#byStudent").show();$("#byGroup").hide()}else if(formatoToSplit()==undefined){$("#byStudent").hide();$("#byGroup").hide()}});function formatoToSplit(){let formatoToSplit=$("#menuformatoToSplit").val();return formatoToSplit}function numberByStudent(){let numberByStudent=$("#numberByStudent").val();return numberByStudent}function numberbygroup(){let numberbygroup=$("#number_by_group").val();return numberbygroup}$("#moreFilter").on("click",function(){$("#history_container").slideDown(250);$("#personal_filter_container").slideDown(250);$("#moreFilter").hide();$("#lessFilter").show();$("#incompatible_container").show()});$("#lessFilter").on("click",function(){lessFilter()});function lessFilter(){$("#history_container").slideUp(250);$("#personal_filter_container").slideUp(250);$("#moreFilter").show();$("#lessFilter").hide();$("#incompatible_container").hide()}function getfilter(){$("#menupersonal_filter").html("");$("<option/>").val(-6).html($choose).attr("disabled","disabled").appendTo("#menupersonal_filter")}$("#create_button").click(function(){if(validationformcreate()==true&&foundstudent==false){$("#save_button").show();$("#modal_button").show();$("#export_button").show();$("#managedelcontainer").show();$("#output_print_conte").hide();$("#output_print_conte").show();$("#csvexport").show();createthegroup()}});function createthegroup(){if(formatoToSplit()==0){togglevalue=numberbygroup()}else if(formatoToSplit()==1){togglevalue=numberByStudent()}let $features=[];togglevalue=parseInt(togglevalue);forgroups=parseInt(formatoToSplit());data={idarray:idarray,forgroups:forgroups,togglevalue:togglevalue,historySt:historySt,$features:$features,tandemvalue:tandemvalue};console.log(data);$.ajax({data:{idarray:idarray,forgroups:forgroups,togglevalue:togglevalue},url:"classes/save/model.php",beforeSend:function(){$("#output_print_conte").html($processing)},success:function(response){console.log(response);let element=response.replace(/&quot;/g,'"');element=JSON.parse(element);if(element.error){$("#output_print_conte").html(" ");$("#output_print_conte").append(`<p class ="text-danger">${$notenoughuser}</p>`)}else if(element.warning){$("#output_print_conte").html(" ");$("#output_print_conte").append(`<p class ="text-warning">${element.warning_messages}</p>`)}else{element=element.group;groupcourse=element;insertIntoOutputPrintConte(element)}}})}let csv={};let csvexport=[];let csvpush={};function insertIntoOutputPrintConte(arraysplitgroups){$(".fitem2").remove();$("#output_print_conte").html(" ");let count=1;let csvGroupkey;let user=[];csv={};csvexport=[];$("#modal_Container").html("");$("#output_print_conte").append(`
    <div><h4> ${valuenametitle} </h4><div>`);$("#modal_Container").append(`
    <div><h4> ${valuenametitle} </h4><div>`);$.each(arraysplitgroups,function(_item,value){csvpush={};csvGroupkey=valuenametitle+count;$("#output_print_conte").append(`
      <div class="fitem2">
        <p class="fitem2 m_bot"> 
          <input type="text" style="border: none" id="`+csvGroupkey+`" value="`+csvGroupkey+`" readonly>
        </p>  
      <div>`);$("#modal_Container").append(`
        <div class="fitem2">
          <p class="fitem2 m_bot">
          <h5 style="border: none" placeholder="`+csvGroupkey+`" id="`+csvGroupkey+`"> ${csvGroupkey} </h5>
          </p>  
        <div>`);user=[];let key;for(let j=0;j<[value.length];j++){for(key in idarrayuser){if(key==value[j]){name=idarrayuser[key];user.push(idarrayuser[key])}}$("#output_print_conte").append(`
          <ul class="fitem2">
            <li class="fitem2">`+name+`</li>
          </ul>
        `);$("#modal_Container").append(`
          <ul class="fitem2">
            <li class="fitem2">`+name+`</li>
          </ul>
        `)}csvpush[csvGroupkey]=user;csv[csvGroupkey]=user;count++;csvexport.push(csvpush)});$("#f_screen").show()}$("#saveGroups").click(function(){saveinhistory()});function saveinhistory(){$("#with_history").prop("checked",false);if($("#incompatible_tandem").is(":checked")){tandem=1}else{tandem=0}let aSplitG=csvexport;let h=historySave;let tV=togglevalue;let k=Object.keys(csv);k=JSON.stringify(k);let vNT=valuenametitle;let idA=JSON.stringify(idarray);let SplitG=JSON.stringify(groupcourse);let idc=idCourse();let idg=idgroup();let t=formatoToSplit();if(h==undefined){h=0}data={idc:idc,idg:idg,t:t,tV:tV,h:h,filter:filter,threshold:threshold,homogenic:homogenic,tandem:tandem,vNT:vNT,k:k,idA:idA,SplitG:SplitG,aSplitG:aSplitG};console.log(data);$.ajax({data:{idc:idc,idg:idg,t:t,tV:tV,h:h,filter:filter,threshold:threshold,homogenic:homogenic,tandem:tandem,vNT:vNT,k:k,idA:idA,SplitG:SplitG},url:"classes/save/savegroupsdb.php",success:function(response){console.log(response);window.location.reload()}})}$("#saveinmoodle").click(function(){$(".validationclass").html("");let aSplitG=arraysplitgroups;let k=Object.keys(csv);k=JSON.stringify(k);let SplitG=JSON.stringify(groupcourse);$.ajax({data:{idC:idCourse(),k:k,SplitG:SplitG},url:"classes/save/saveteamsmoodle.php",success:function(response){console.log(response)}});saveinhistory()});$("#f_screen").on("click",function(){$("#modal_Cont").show()});$("#x").on("click",function(){$("#modal_Cont").hide()});$("#refresh").on("click",function(){$("#form1")[0].reset();$(".fitem").remove();$(".fitem2").remove();$("#output_print_conte").hide();$("#modal_button").hide();restar();$("#with_history").prop("checked",false);$("#save_button").hide();$("#managedelcontainer").hide();emptyvaluetitle()});function validationformcreate(){$(".validationclass").html("");if($("#typeNameFilter").val()==0||$("#typeNameFilter").val()==""||$("#typeNameFilter").val()===null){$("#valiTitleContainer").append(`<p class="text-danger"><small>${$typename}</small></p>`);return false}if(idCourse()==""||idCourse()===null||idCourse()==undefined){$("#valiCourseContainer").append(`<p class="text-danger"><small>${$idcourse}</small></p>`);return false}if(idgroup()!=1&&idgroup()==-2){$("#valiCourseGroupContainer").append(`<small class="text-danger">${$idgroup}</small>`);return false}if(formatoToSplit()==""||formatoToSplit()===null||formatoToSplit()==undefined){$("#valiFormatContainer").append(`<small class="text-danger">${$formatosplit}</small>`);return false}if(formatoToSplit()==1){if(numberByStudent()==" "){$("#valiStudentsContainer").append(`<small class="text-danger">${$numberstudent}</small>`);return false}if(numberByStudent()==0){$("#valiStudentsContainer").append(`<small class="text-danger">${$numberstudentzero}</small>`);return false}if(parseFloat(numberByStudent())===isNaN||isFinite(numberByStudent())!==true){$("#valiStudentsContainer").append(`<small class="text-danger">${$numberstudent}</small>`);return false}}if(formatoToSplit()==0){if(numberbygroup()==" "){$("#valiGroupContainer").append(`<small class="text-danger">${$numbergrouop}</small>`);return false}if(numberbygroup()==0){$("#valiGroupContainer").append(`<small class="text-danger">${$numbergrouopzero}</small>`);return false}if(parseFloat(numberbygroup())===isNaN||isFinite(numberbygroup())!==true){$("#valiGroupContainer").append(`<small class="text-danger">${$numbergrouop}</small>`);return false}}return true}function restar(){$("#group_course").hide();$("#menuformatoToSplit").prop("selectedIndex",0);$("#byStudent").hide();$("#byGroup").hide();lessFilter();$("#lessFilter").hide();$("#with_history").prop("checked",false);$("#history_container").hide();history={};historySt=[];$("#custom_filter_cooperative").hide();$("#incompatible_tandem").prop("checked",false);tandem=[];$("#incompatible_container").hide();$("#personal_filter_container").hide();$("#menupersonal_filter").prop("selectedIndex",0);personalfilter=[];personalfiltervalue="";personalfilterstudent="";$("#custom_filter_homogenic").hide();$("#heterogenic_checkbox").prop("checked",false);$("#homogenic_checkbox").prop("checked",false);$("#threshold_container").hide();$("#output_print_conte").hide();$("#result_personal_filter").hide();$("#modal_Cont").hide();$("#modal_button").hide();$(".fitem").remove();$("#export_button").hide();$("#explain_course").hide();$("#explain_groupcourse").hide();$("#explain_formatsplit").hide();$("#explain_bystudent").hide();$("#explain_bygroup").hide();$("#explain_history").hide();$("#explain_tandem").hide();$("#explain_personalfilter").hide();$("#explain_homogenic").hide();$("#explain_heterogenic").hide();$("#explain_threshold").hide();$("#explain_title_container").hide();$("#f_screen").hide();$("#csvexport").hide();$(".validationclass").html("")}restar()})});