// This file is part of Moodle - https://moodle.org/
//
// Moodle is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Moodle is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.

/**
 * Javascript
 *
 * @package     local_classroom_teams
 * @author      2022 JuanCarlo Castillo <juancarlo.castillo20@gmail.com>
 * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @copyright   2022 JuanCa Castillo & Eurecat.dev
  */


function setStatusTeams(active,url){require(["jquery"],function($){$(document).ready(function(){$.ajax({url:url,data:{active:active},success:function(data){console.log("status")},error:function(xhr,textStatus,errorThrown){console.log("Error! "+errorThrown)}})})})}function sethTeams(h,finalUrl,host){require(["jquery"],function($){$(document).ready(function(){$.ajax({url:finalUrl,data:{h:h,host:host},success:function(data){console.log("set data")},error:function(xhr,textStatus,errorThrown){console.log("Error! "+errorThrown)}})})})}function setHeaders(headers,xhr){if(headers){for(const key in headers){if(headers.hasOwnProperty(key)){xhr.setRequestHeader(key,headers[key])}}}}async function woocommerce_api_active_teams(yui,apikey,product_id,email){try{var url="https://lab.eurecatacademy.org/?wc-api=wc-am-api&wc_am_action=activate";let urlactualObjectTeams=new URL(window.location.href);let urlactualString=window.location.href;let newUrl=urlactualString.replace(/\/admin(.*)$/,"");let finalUrl=newUrl+"/local/classroom_teams/classes/settings/teamssavehash.php";const host=urlactualObjectTeams.host;const hash=await hashStringTeams(host+"classroom");sethTeams(hash,finalUrl,host);var params={instance:hash,object:email,product_id:product_id,api_key:apikey};const queryString=Object.keys(params).map(key=>`${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`).join("&");const call_url_teams=url+"&"+queryString;var xhr=new XMLHttpRequest;xhr.open("GET",call_url_teams);xhr.responseType="json";xhr.onload=function(){if(xhr.status===200){var data=xhr.response;console.log(data.success)}else{console.error("Error getting data from API endpoint")}};xhr.send();return data}catch(err){console.log(err)}}async function woocommerce_api_status_teams(yui,apikey,product_id,email){try{var url="https://lab.eurecatacademy.org/?wc-api=wc-am-api&wc_am_action=status";let urlactual=new URL(window.location.href);let urlactualString=window.location.href;let newUrl=urlactualString.replace(/\/index(.*)$/,"");let finalUrl=newUrl+"/classes/settings/teamssavehash.php";let settingslUrl=newUrl+"/classes/settings/settingsteams.php";const host=urlactual.host;const hash=await hashStringTeams(host+"classroom");var params={instance:hash,object:email,product_id:product_id,api_key:apikey};const queryString=Object.keys(params).map(key=>`${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`).join("&");const call_url=url+"&"+queryString;var xhr=new XMLHttpRequest;xhr.open("GET",call_url);xhr.responseType="json";xhr.onload=function(){if(xhr.status===200){var data=xhr.response;if(data.status_check=="active"){var active=1;sethTeams(hash,finalUrl,host);setStatusTeams(active,settingslUrl);insertIntoDivTeams("Active User")}else{var active=0;setStatus(active,settingslUrl)}}else{console.error("Error getting data from API endpoint")}};xhr.send();return data}catch(err){console.log(err)}}async function hashStringTeams(str){const encoder=new TextEncoder;const data=encoder.encode(str);const buffer=await crypto.subtle.digest("SHA-256",data);const hashArray=Array.from(new Uint8Array(buffer));const hashHex=hashArray.map(b=>b.toString(16).padStart(2,"0")).join("");return hashHex}function insertIntoDivTeams(text){var divInclude=document.getElementById("statusformteams");divInclude.innerHTML="<p class='text-info'>"+text+"</p>";var closeButton=document.createElement("button");closeButton.innerHTML="Ã—";closeButton.type="button";closeButton.classList.add("close");closeButton.addEventListener("click",function(){divInclude.innerHTML="";divInclude.classList.remove("p-3","mb-3","rounded","bg-light","opacity-75","d-flex","justify-content-between","align-items-center")});divInclude.appendChild(closeButton);divInclude.classList.add("p-3","mb-3","rounded","bg-light","opacity-75","d-flex","justify-content-between","align-items-center")}